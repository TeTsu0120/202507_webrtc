<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>WebRTC Viewer</title>
</head>
<body>
  <video id="video" autoplay playsinline controls></video>
  <script>
    const video = document.getElementById("video");

    const pc = new RTCPeerConnection({
    iceServers: [
        { urls: "stun:stun.l.google.com:19302" }
    ]
    });
    const ws = new WebSocket("ws://localhost:8080/ws");

    // ãƒªãƒ¢ãƒ¼ãƒˆã‚¹ãƒˆãƒªãƒ¼ãƒ å—ä¿¡æ™‚
    pc.ontrack = (event) => {
      if (video.srcObject !== event.streams[0]) {
        video.srcObject = event.streams[0];
        console.log("âœ… Received remote stream");
      }
    };

    // ICE candidateå–å¾—æ™‚ï¼ˆ1å›žã ã‘è¨­å®šï¼‰
    pc.onicecandidate = (event) => {
      if (event.candidate) {
        console.log("ICE candidate gathered:", event.candidate.candidate);
        if (ws.readyState === WebSocket.OPEN) {
          ws.send(JSON.stringify(event.candidate));
          console.log("Sent ICE candidate to signaling server");
        } else {
          console.warn("WebSocket not open, ICE candidate not sent");
        }
      } else {
        console.log("ICE candidate gathering finished");
      }
    };

    // ICE gatheringå®Œäº†ã‚’å¾…ã¤Promiseï¼ˆonicecandidateã¯æ“ä½œã—ãªã„ï¼‰
    function waitForIceGatheringComplete(pc) {
      return new Promise((resolve) => {
        if (pc.iceGatheringState === "complete") {
          console.log("ICE gathering already complete");
          resolve();
        } else {
          const onStateChange = () => {
            console.log("ICE gathering state changed:", pc.iceGatheringState);
            if (pc.iceGatheringState === "complete") {
              pc.removeEventListener("icegatheringstatechange", onStateChange);
              resolve();
            }
          };
          pc.addEventListener("icegatheringstatechange", onStateChange);
        }
      });
    }

    ws.onopen = async () => {
      console.log("WebSocket connected. Creating offer...");

      try {
        const offer = await pc.createOffer();
        console.log("âœ… Created offer:", offer.sdp);

        await pc.setLocalDescription(offer);
        console.log("âœ… Set local description");

        await waitForIceGatheringComplete(pc);
        console.log("âœ… ICE gathering complete");

        ws.send(JSON.stringify(pc.localDescription));
        console.log("âœ… Sent SDP offer:", pc.localDescription.sdp);
      } catch (e) {
        console.error("Error during offer creation or ICE gathering:", e);
      }
    };

    ws.onmessage = async (event) => {
      const msg = JSON.parse(event.data);

      if (msg.type === "answer") {
        console.log("ðŸ“¥ Received SDP answer");
        try {
          await pc.setRemoteDescription(new RTCSessionDescription(msg));
          console.log("âœ… Set remote description");
        } catch (e) {
          console.error("Failed to set remote description:", e);
        }
      } else if (msg.candidate) {
        console.log("ðŸ“¥ Received ICE candidate");
        try {
          await pc.addIceCandidate(msg);
          console.log("âœ… Added ICE candidate");
        } catch (e) {
          console.error("âš ï¸ Failed to add ICE candidate:", e);
        }
      }
    };

    ws.onerror = (e) => {
      console.error("WebSocket error:", e);
    };

    ws.onclose = (e) => {
      console.warn("WebSocket closed:", e);
    };
  </script>
</body>
</html>

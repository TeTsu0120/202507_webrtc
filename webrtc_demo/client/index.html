<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>WebRTC Viewer</title>
</head>
<body>
  <video id="video" muted autoplay playsinline controls></video>

  <script>
    const video = document.getElementById("video");
    // const turnUrl = `turn:172.31.128.1:3478`
    const pc = new RTCPeerConnection({
      iceServers: [
        // { urls: "stun:localhost:3478" },
        { urls: "stun:stun.l.google.com:19302" }, // „Åæ„Åö„ÅØGoogle„ÅÆSTUN„ÅßË©¶„Åô
        {
          urls: "turn:172.31.128.1:3478",
          username: "testuser",
          credential: "testpass"
        }
      ]
    });

    // Êò†ÂÉè„ÅÆÂèó‰ø°Áî®„Å´„Éà„É©„É≥„Ç∑„Éº„Éê„Éº„ÇíËøΩÂä†Ôºà„Çµ„Éº„Éê„Éº„ÅåÈÄÅ„Å£„Å¶„Åè„ÇãÂâçÊèêÔºâ
    pc.addTransceiver("video", { direction: "recvonly" });

    const ws = new WebSocket("ws://localhost:8080/ws");

    // Êò†ÂÉèÂèó‰ø°„Ç§„Éô„É≥„Éà„ÅÆË©≥Á¥∞„É≠„Ç∞ËøΩÂä†
    pc.ontrack = (event) => {
      console.log("=== ontrack event start ===");
      console.log("‚ñ∂Ô∏è ontrack event fired");
      console.log("  event.streams.length:", event.streams.length);

      if (video.srcObject !== event.streams[0]) {
        video.srcObject = event.streams[0];
        console.log("  Set video.srcObject to new MediaStream");

        video.play()
          .then(() => {
            console.log("  video.play() succeeded");
          })
          .catch((e) => {
            console.warn("  video.play() failed:", e);
          });
      } else {
        console.log("  video.srcObject already set to this stream, skipping play()");
      }

      console.log("  video.paused:", video.paused);
      console.log("  video.readyState:", video.readyState);
      console.log("  video.srcObject tracks count:", video.srcObject ? video.srcObject.getTracks().length : 0);
      console.log("=== ontrack event end ===");
    };

    // ICE candidateÂèéÈõÜ
    pc.onicecandidate = (event) => {
      if (event.candidate) {
        console.log("üßä ICE candidate gathered:", event.candidate.candidate);
        if (ws.readyState === WebSocket.OPEN) {
          ws.send(JSON.stringify(event.candidate));
          console.log("üì§ Sent ICE candidate to signaling server");
        } else {
          console.warn("WebSocket not open, ICE candidate not sent");
        }
      } else {
        console.log("‚úÖ ICE candidate gathering finished");
      }
    };

    // ICE connection stateÂ§âÊõ¥„ÅÆ„É≠„Ç∞
    pc.oniceconnectionstatechange = () => {
      console.log("üîÑ ICE connection state:", pc.iceConnectionState);
    };

    // PeerConnection„ÅÆÂÖ®‰ΩìÊé•Á∂öÁä∂ÊÖãÂ§âÊõ¥„ÅÆ„É≠„Ç∞
    pc.onconnectionstatechange = () => {
      console.log("üîÑ PeerConnection state:", pc.connectionState);
    };

    // ICE gathering ÂÆå‰∫Ü„ÇíÂæÖ„Å§ Promise
    function waitForIceGatheringComplete(pc) {
      return new Promise((resolve) => {
        if (pc.iceGatheringState === "complete") {
          console.log("‚úÖ ICE gathering already complete");
          resolve();
        } else {
          const onStateChange = () => {
            console.log("üîÑ ICE gathering state:", pc.iceGatheringState);
            if (pc.iceGatheringState === "complete") {
              pc.removeEventListener("icegatheringstatechange", onStateChange);
              console.log("‚úÖ ICE gathering complete");
              resolve();
            }
          };
          pc.addEventListener("icegatheringstatechange", onStateChange);
        }
      });
    }

    // WebSocketÊé•Á∂öÂæå„Å´„Ç™„Éï„Ç°„Éº‰ΩúÊàê
    ws.onopen = async () => {
      console.log("üåê WebSocket connected. Creating offer...");

      try {
        const offer = await pc.createOffer();
        console.log("üìÑ Created SDP offer:\n", offer.sdp);

        await pc.setLocalDescription(offer);
        console.log("üìç Set local description");

        await waitForIceGatheringComplete(pc);

        ws.send(JSON.stringify(pc.localDescription));
        console.log("üì§ Sent SDP offer with ICE candidates");
      } catch (err) {
        console.error("‚ùå Error during offer/ICE gathering:", err);
      }
    };

    // „É°„ÉÉ„Çª„Éº„Ç∏Âèó‰ø°
    ws.onmessage = async (event) => {
      const msg = JSON.parse(event.data);

      if (msg.type === "answer") {
        console.log("üì• Received SDP answer");
        try {
          await pc.setRemoteDescription(new RTCSessionDescription(msg));
          console.log("‚úÖ Set remote description");
        } catch (err) {
          console.error("‚ùå Failed to set remote description:", err);
        }
      } else if (msg.candidate) {
        console.log("üì• Received ICE candidate");
        try {
          await pc.addIceCandidate(msg);
          console.log("‚úÖ Added ICE candidate");
        } catch (err) {
          console.error("‚ö†Ô∏è Failed to add ICE candidate:", err);
        }
      }
    };

    ws.onerror = (e) => {
      console.error("‚ùó WebSocket error:", e);
    };

    ws.onclose = (e) => {
      console.warn("‚ö†Ô∏è WebSocket closed:", e);
    };

  </script>
</body>
</html>

<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>WebRTC Viewer</title>
</head>
<body>
  <video id="video" autoplay playsinline controls></video>

  <script>
    const video = document.getElementById("video");

    const pc = new RTCPeerConnection({
    iceServers: [
      // { urls: "stun:localhost:3478" },
       { urls: "stun:stun.l.google.com:19302" } // „Åæ„Åö„ÅØGoogle„ÅÆSTUN„ÅßË©¶„Åô
    ]
    });
    // Êò†ÂÉè„ÅÆÂèó‰ø°Áî®„Å´„Éà„É©„É≥„Ç∑„Éº„Éê„Éº„ÇíËøΩÂä†Ôºà„Çµ„Éº„Éê„Éº„ÅåÈÄÅ„Å£„Å¶„Åè„ÇãÂâçÊèêÔºâ
    pc.addTransceiver("video", { direction: "recvonly" });  
    const ws = new WebSocket("ws://localhost:8080/ws");

    // „É™„É¢„Éº„Éà„Çπ„Éà„É™„Éº„É†„Çí video „Å´Ë®≠ÂÆö
    pc.ontrack = (event) => {
      if (video.srcObject !== event.streams[0]) {
        video.srcObject = event.streams[0];
        console.log("‚úÖ Received remote stream");
      }
    };

    // ICE candidate ÂèéÈõÜ
    pc.onicecandidate = (event) => {
      if (event.candidate) {
        console.log("üßä ICE candidate gathered:", event.candidate.candidate);
        if (ws.readyState === WebSocket.OPEN) {
          ws.send(JSON.stringify(event.candidate));
          console.log("üì§ Sent ICE candidate to signaling server");
        } else {
          console.warn("WebSocket not open, ICE candidate not sent");
        }
      } else {
        console.log("‚úÖ ICE candidate gathering finished");
      }
    };

    // ICE gathering ÂÆå‰∫Ü„ÇíÂæÖ„Å§ Promise
    function waitForIceGatheringComplete(pc) {
      return new Promise((resolve) => {
        if (pc.iceGatheringState === "complete") {
          console.log("‚úÖ ICE gathering already complete");
          resolve();
        } else {
          const onStateChange = () => {
            console.log("üîÑ ICE gathering state:", pc.iceGatheringState);
            if (pc.iceGatheringState === "complete") {
              pc.removeEventListener("icegatheringstatechange", onStateChange);
              console.log("‚úÖ ICE gathering complete");
              resolve();
            }
          };
          pc.addEventListener("icegatheringstatechange", onStateChange);
        }
      });
    }

    // WebSocketÊé•Á∂öÂæå„Å´„Ç™„Éï„Ç°„Éº‰ΩúÊàê
    ws.onopen = async () => {
      console.log("üåê WebSocket connected. Creating offer...");

      try {
        const offer = await pc.createOffer();
        console.log("üìÑ Created SDP offer:\n", offer.sdp);

        await pc.setLocalDescription(offer);
        console.log("üìç Set local description");

        await waitForIceGatheringComplete(pc);

        ws.send(JSON.stringify(pc.localDescription));
        console.log("üì§ Sent SDP offer with ICE candidates");
      } catch (err) {
        console.error("‚ùå Error during offer/ICE gathering:", err);
      }
    };

    // „É°„ÉÉ„Çª„Éº„Ç∏Âèó‰ø°
    ws.onmessage = async (event) => {
      const msg = JSON.parse(event.data);

      if (msg.type === "answer") {
        console.log("üì• Received SDP answer");
        try {
          await pc.setRemoteDescription(new RTCSessionDescription(msg));
          console.log("‚úÖ Set remote description");
        } catch (err) {
          console.error("‚ùå Failed to set remote description:", err);
        }
      } else if (msg.candidate) {
        console.log("üì• Received ICE candidate");
        try {
          await pc.addIceCandidate(msg);
          console.log("‚úÖ Added ICE candidate");
        } catch (err) {
          console.error("‚ö†Ô∏è Failed to add ICE candidate:", err);
        }
      }
    };

    ws.onerror = (e) => {
      console.error("‚ùó WebSocket error:", e);
    };

    ws.onclose = (e) => {
      console.warn("‚ö†Ô∏è WebSocket closed:", e);
    };
  </script>
</body>
</html>
